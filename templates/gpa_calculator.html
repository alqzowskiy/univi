<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPA Calculator - UNIVI AI</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <!-- Add this to the head section of gpa_calculator.html -->
    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            // Get DOM elements
            const gradingSystemBtns = document.querySelectorAll('[name="gradingSystem"]');
            const subjectsContainer = document.getElementById('subjectsContainer');
            const addSubjectBtn = document.querySelector('[aria-label="Add Subject"]');
            const calculateBtn = document.querySelector('[aria-label="Calculate GPA"]');
            const resultSection = document.getElementById('resultSection');
            const errorSection = document.getElementById('errorSection');
            const gpaResult = document.getElementById('gpaResult');

            let currentSystem = 'letter'; // Default grading system

            // Grade point mappings
            const letterToGPA = {
                'A+': 4.0, 'A': 4.0, 'A-': 3.7,
                'B+': 3.3, 'B': 3.0, 'B-': 2.7,
                'C+': 2.3, 'C': 2.0, 'C-': 1.7,
                'D+': 1.3, 'D': 1.0, 'D-': 0.7,
                'F': 0.0
            };

            // Helper function to create a new subject row
            function createSubjectRow() {
                const row = document.createElement('div');
                row.className = 'subject-row flex md:flex-row flex-col gap-4 bg-gray-50 md:bg-transparent p-4 md:p-0 rounded-lg';

                row.innerHTML = `
                <input type="text" class="flex-1 p-2 border rounded-lg" placeholder="Subject Name" required>
                <input type="number" class="w-24 p-2 border rounded-lg" placeholder="Credits" min="0" step="0.5" required>
                <select class="w-24 p-2 border rounded-lg grade-select">
                    ${currentSystem === 'letter' ?
                        Object.keys(letterToGPA).map(grade =>
                            `<option value="${grade}">${grade}</option>`
                        ).join('') :
                        '<option value="">Grade</option>'}
                </select>
                <button class="delete-subject text-red-500 hover:text-red-700">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            `;

                return row;
            }

            // Add initial subject row
            subjectsContainer.appendChild(createSubjectRow());

            // Event Listeners
            addSubjectBtn?.addEventListener('click', () => {
                subjectsContainer.appendChild(createSubjectRow());
            });

            subjectsContainer.addEventListener('click', (e) => {
                if (e.target.closest('.delete-subject')) {
                    const row = e.target.closest('.subject-row');
                    if (subjectsContainer.children.length > 1) {
                        row.remove();
                    }
                }
            });

            // Handle grading system change
            gradingSystemBtns.forEach(btn => {
                btn.addEventListener('change', (e) => {
                    currentSystem = e.target.value;
                    // Clear and recreate subject rows
                    subjectsContainer.innerHTML = '';
                    subjectsContainer.appendChild(createSubjectRow());
                });
            });

            // Calculate GPA and save to Firebase
            calculateBtn?.addEventListener('click', async () => {
                try {
                    const user = window.auth.currentUser;
                    if (!user) {
                        throw new Error('Please log in to save your GPA');
                    }

                    const subjects = [];
                    let totalPoints = 0;
                    let totalCredits = 0;

                    // Gather subject data
                    document.querySelectorAll('.subject-row').forEach(row => {
                        const subjectName = row.querySelector('input[type="text"]').value;
                        const credits = parseFloat(row.querySelector('input[type="number"]').value);
                        const grade = row.querySelector('select').value;

                        if (!subjectName || isNaN(credits) || !grade) {
                            throw new Error('Please fill in all fields');
                        }

                        let gradePoints;
                        if (currentSystem === 'letter') {
                            gradePoints = letterToGPA[grade];
                        } else {
                            gradePoints = parseFloat(grade);
                        }

                        subjects.push({ subjectName, credits, grade });
                        totalPoints += gradePoints * credits;
                        totalCredits += credits;
                    });

                    if (totalCredits === 0) {
                        throw new Error('Total credits cannot be zero');
                    }

                    const gpa = totalPoints / totalCredits;
                    const roundedGPA = Math.round(gpa * 100) / 100;

                    // Save to Firebase
                    const userRef = window.db.collection('users').doc(user.uid);
                    await userRef.update({
                        gpa: roundedGPA,
                        lastGPAUpdate: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // Save detailed GPA data
                    const gpaDetailsRef = userRef.collection('gpaDetails').doc('latest');
                    await gpaDetailsRef.set({
                        gpa: roundedGPA,
                        subjects: subjects,
                        gradingSystem: currentSystem,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // Add activity
                    await userRef.collection('activity').add({
                        description: `Updated GPA to ${roundedGPA}`,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // Show result
                    gpaResult.textContent = roundedGPA.toFixed(2);
                    resultSection.classList.remove('hidden');
                    errorSection.classList.add('hidden');

                    // Redirect to profile after short delay
                    setTimeout(() => {
                        window.location.href = '/user';
                    }, 2000);

                } catch (error) {
                    console.error('Error calculating GPA:', error);
                    errorSection.textContent = error.message;
                    errorSection.classList.remove('hidden');
                    resultSection.classList.add('hidden');
                }
            });

            // Load existing GPA data if available
            async function loadExistingGPA() {
                try {
                    const user = window.auth.currentUser;
                    if (!user) return;

                    const gpaDetailsRef = window.db.collection('users').doc(user.uid)
                        .collection('gpaDetails').doc('latest');
                    const doc = await gpaDetailsRef.get();

                    if (doc.exists) {
                        const data = doc.data();
                        if (data.subjects && data.subjects.length > 0) {
                            // Clear existing rows
                            subjectsContainer.innerHTML = '';

                            // Set grading system
                            document.querySelector(`[name="gradingSystem"][value="${data.gradingSystem}"]`).checked = true;
                            currentSystem = data.gradingSystem;

                            // Add subject rows with data
                            data.subjects.forEach(subject => {
                                const row = createSubjectRow();
                                row.querySelector('input[type="text"]').value = subject.subjectName;
                                row.querySelector('input[type="number"]').value = subject.credits;
                                row.querySelector('select').value = subject.grade;
                                subjectsContainer.appendChild(row);
                            });
                        }
                    }
                } catch (error) {
                    console.error('Error loading existing GPA:', error);
                }
            }

            // After Firebase initialization, add these security rules
            document.addEventListener('DOMContentLoaded', async function () {
                try {
                    // Wait for Firebase Auth to initialize
                    await new Promise((resolve) => {
                        const unsubscribe = window.auth.onAuthStateChanged((user) => {
                            unsubscribe();
                            resolve(user);
                        });
                    });

                    // Add auth state observer
                    window.auth.onAuthStateChanged(async (user) => {
                        if (!user) {
                            window.location.href = '/login';
                            return;
                        }

                        // Load existing GPA data after confirming auth
                        try {
                            const userDoc = await window.db.collection('users').doc(user.uid).get();
                            const gpaDetailsDoc = await window.db.collection('users').doc(user.uid)
                                .collection('gpaDetails').doc('latest').get();

                            if (gpaDetailsDoc.exists) {
                                const data = gpaDetailsDoc.data();
                                displayExistingGPA(data);
                            }
                        } catch (error) {
                            console.error('Error loading GPA data:', error);
                            // Don't show error to user, just log it
                        }
                    });

                    // Function to save GPA
                    async function saveGPA(gpaData) {
                        const user = window.auth.currentUser;
                        if (!user) throw new Error('Not authenticated');

                        const batch = window.db.batch();
                        const userRef = window.db.collection('users').doc(user.uid);
                        const gpaDetailsRef = userRef.collection('gpaDetails').doc('latest');

                        // Update main user document
                        batch.update(userRef, {
                            gpa: gpaData.gpa,
                            lastGPAUpdate: firebase.firestore.FieldValue.serverTimestamp()
                        });

                        // Save detailed GPA data
                        batch.set(gpaDetailsRef, {
                            ...gpaData,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });

                        // Add to activity log
                        const activityRef = userRef.collection('activity').doc();
                        batch.set(activityRef, {
                            description: `Updated GPA to ${gpaData.gpa.toFixed(2)}`,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });

                        await batch.commit();
                    }

                    // Update calculate button click handler
                    document.querySelector('[aria-label="Calculate GPA"]').addEventListener('click', async () => {
                        try {
                            const gpaData = calculateGPAData();
                            await saveGPA(gpaData);
                            showSuccess(gpaData.gpa);

                            // Redirect after short delay
                            setTimeout(() => {
                                window.location.href = '/user';
                            }, 1500);
                        } catch (error) {
                            console.error('Error saving GPA:', error);
                            showError(error.message);
                        }
                    });

                } catch (error) {
                    console.error('Firebase initialization error:', error);
                }
            });

            // Helper function to calculate GPA
            function calculateGPAData() {
                const subjects = [];
                let totalPoints = 0;
                let totalCredits = 0;

                document.querySelectorAll('.subject-row').forEach(row => {
                    const subjectName = row.querySelector('input[type="text"]').value.trim();
                    const credits = parseFloat(row.querySelector('input[type="number"]').value);
                    const grade = row.querySelector('.grade-input').value;

                    if (!subjectName || isNaN(credits) || !grade) {
                        throw new Error('Please fill in all fields');
                    }

                    let gradePoints;
                    if (currentGradingSystem === 'letter') {
                        gradePoints = letterToGPA[grade] || 0;
                    } else {
                        gradePoints = parseFloat(grade);
                        if (gradePoints < 2 || gradePoints > 5) {
                            throw new Error('Numeric grades must be between 2.0 and 5.0');
                        }
                    }

                    subjects.push({ subjectName, credits, grade });
                    totalPoints += gradePoints * credits;
                    totalCredits += credits;
                });

                if (totalCredits === 0) {
                    throw new Error('Total credits cannot be zero');
                }

                return {
                    gpa: Math.round((totalPoints / totalCredits) * 100) / 100,
                    subjects,
                    gradingSystem: currentGradingSystem,
                    totalCredits: totalCredits
                };
            }
            // Check auth state and load data
            window.auth?.onAuthStateChanged((user) => {
                if (user) {
                    loadExistingGPA();
                } else {
                    window.location.href = '/login';
                }
            });
        });
    </script>
    {% include 'partials/firebaseconfig.html' %}
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            /* Жирное начертание для заголовков */
        }

        p {
            font-family: 'Montserrat', sans-serif;
            font-weight: 400;
            /* Обычное начертание для текста */
            font-size: 16px;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(229, 231, 235, 0.5);
        }

        .nav-link {
            position: relative;
            transition: all 0.3s ease;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .subject-row {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
                background-color: #f9fafb;
                border-radius: 0.5rem;
                margin-bottom: 1rem;
            }

            .subject-row input,
            .subject-row select {
                width: 100%;
            }

            .subject-row button {
                align-self: flex-end;
            }

            /* Grading System Buttons */
            .grading-buttons {
                flex-direction: column;
                gap: 0.5rem;
            }

            .grading-buttons button {
                width: 100%;
                padding: 0.75rem;
                justify-content: center;
            }

            /* Action Buttons */
            .action-buttons {
                flex-direction: column;
                gap: 0.5rem;
            }

            .action-buttons button {
                width: 100%;
                justify-content: center;
            }

            /* Container Padding */
            .container-padding {
                padding-left: 1rem;
                padding-right: 1rem;
            }

            /* Mobile Menu Improvements */
            .mobile-menu-items {
                width: 100%;
                padding: 0.5rem;
            }

            .mobile-menu-items a {
                width: 100%;
                padding: 1rem;
                border-radius: 0.5rem;
            }
        }

        /* Enhanced Mobile Navigation */
        @media (max-width: 640px) {
            .nav-container {
                padding: 0 1rem;
            }

            .logo-text {
                font-size: 1.5rem;
            }

            .mobile-menu {
                max-height: calc(100vh - 5rem);
                overflow-y: auto;
            }
        }

        .nav-link::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            width: 0;
            height: 2px;
            background: #3b82f6;
            transition: all 0.3s ease;
            transform: translateX(-50%);
        }

        .nav-link:hover::after {
            width: 100%;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">

    <body class="bg-gray-50">
        {% include 'partials/navigation.html' %}

        <!-- Main Content -->
        <div class="pt-32 pb-20">
            <div class="max-w-4xl mx-auto px-4">
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <h1 class="text-3xl font-bold text-center mb-8">GPA Calculator</h1>

                    <div class="mb-8">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Grading System</label>
                        <div class="flex flex-col md:flex-row gap-4">
                            <button onclick="setGradingSystem('letter')" id="letterBtn"
                                class="w-full md:w-auto px-4 py-2 rounded-lg bg-blue-600 text-white">
                                Letter Grades (A-F)
                            </button>
                            <button onclick="setGradingSystem('numeric')" id="numericBtn"
                                class="w-full md:w-auto px-4 py-2 rounded-lg bg-gray-100 text-gray-700">
                                Numeric Grades (2-5)
                            </button>
                        </div>
                    </div>

                    <template id="subjectRowTemplate">
                        <div
                            class="subject-row flex md:flex-row flex-col gap-4 bg-gray-50 md:bg-transparent p-4 md:p-0 rounded-lg">
                            <input type="text" placeholder="Subject Name" class="flex-1 p-2 border rounded">
                            <select class="grade-input w-full md:w-24 p-2 border rounded">
                                <option value="">Grade</option>
                                <option value="A+">A+</option>
                                <option value="A">A</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B">B</option>
                                <option value="B-">B-</option>
                                <option value="C+">C+</option>
                                <option value="C">C</option>
                                <option value="C-">C-</option>
                                <option value="D+">D+</option>
                                <option value="D">D</option>
                                <option value="D-">D-</option>
                                <option value="F">F</option>
                            </select>
                            <input type="number" placeholder="Credits" class="w-full md:w-24 p-2 border rounded-lg"
                                min="0" step="0.5">
                            <button onclick="removeSubject(this)" class="p-2 text-red-600 hover:text-red-800 self-end">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </template>
                    <div id="subjectsContainer" class="space-y-4 mb-8">
                        <!-- Initial subject row -->
                        <div
                            class="subject-row flex md:flex-row flex-col gap-4 bg-gray-50 md:bg-transparent p-4 md:p-0 rounded-lg">
                            <input type="text" placeholder="Subject Name" class="flex-1 p-2 border rounded-lg">
                            <select class="grade-input w-full md:w-24 p-2 border rounded-lg">
                                <option value="">Grade</option>
                                <option value="A+">A+</option>
                                <option value="A">A</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B">B</option>
                                <option value="B-">B-</option>
                                <option value="C+">C+</option>
                                <option value="C">C</option>
                                <option value="C-">C-</option>
                                <option value="D+">D+</option>
                                <option value="D">D</option>
                                <option value="D-">D-</option>
                                <option value="F">F</option>
                            </select>
                            <input type="number" placeholder="Credits" class="w-full md:w-24 p-2 border rounded-lg"
                                min="0" step="0.5">
                            <button onclick="removeSubject(this)" class="p-2 text-red-600 hover:text-red-800 self-end">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div class="flex flex-col md:flex-row gap-4 mb-8">
                        <button onclick="addSubject()"
                            class="w-full md:w-auto flex items-center justify-center gap-2 px-4 py-2 bg-gray-100 rounded-lg text-gray-700 hover:bg-gray-200">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                            Add Subject
                        </button>
                        <button onclick="calculateGPA()"
                            class="w-full md:w-auto flex items-center justify-center gap-2 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                            </svg>
                            Calculate GPA
                        </button>
                    </div>

                    <!-- Result Section -->
                    <div id="resultSection" class="hidden p-6 bg-blue-50 rounded-lg">
                        <h3 class="text-xl font-semibold text-blue-900">Your GPA: <span id="gpaResult"></span></h3>
                        <p class="text-blue-600 mt-2" id="gpaMessage"></p>
                    </div>

                    <!-- Error Section -->
                    <div id="errorSection" class="hidden p-4 bg-red-50 text-red-700 rounded-lg mt-4"></div>
                </div>
            </div>
        </div>

        <script>
            let currentGradingSystem = 'letter';

            function setGradingSystem(system) {
                currentGradingSystem = system;
                const letterBtn = document.getElementById('letterBtn');
                const numericBtn = document.getElementById('numericBtn');

                if (system === 'letter') {
                    letterBtn.classList.remove('bg-gray-100', 'text-gray-700');
                    letterBtn.classList.add('bg-blue-600', 'text-white');
                    numericBtn.classList.remove('bg-blue-600', 'text-white');
                    numericBtn.classList.add('bg-gray-100', 'text-gray-700');
                    updateGradeInputs('letter');
                } else {
                    numericBtn.classList.remove('bg-gray-100', 'text-gray-700');
                    numericBtn.classList.add('bg-blue-600', 'text-white');
                    letterBtn.classList.remove('bg-blue-600', 'text-white');
                    letterBtn.classList.add('bg-gray-100', 'text-gray-700');
                    updateGradeInputs('numeric');
                }
            }
            function numericToGPA(grade) {
                // Convert 2-5 scale to 4.0 scale
                if (grade < 2 || grade > 5) {
                    throw new Error('Numeric grades must be between 2.0 and 5.0');
                }

                // Linear conversion from 2-5 scale to 0-4 scale
                return ((grade - 2) / 3) * 4;
            }

            function updateGradeInputs(type) {
                const rows = document.querySelectorAll('.subject-row');
                rows.forEach(row => {
                    const gradeInput = row.querySelector('.grade-input');
                    const currentValue = gradeInput.value;

                    if (type === 'letter') {
                        const select = document.createElement('select');
                        select.className = 'grade-input w-24 p-2 border rounded';
                        select.innerHTML = `
                        <option value="">Grade</option>
                        <option value="A+">A+</option>
                        <option value="A">A</option>
                        <option value="A-">A-</option>
                        <option value="B+">B+</option>
                        <option value="B">B</option>
                        <option value="B-">B-</option>
                        <option value="C+">C+</option>
                        <option value="C">C</option>
                        <option value="C-">C-</option>
                        <option value="D+">D+</option>
                        <option value="D">D</option>
                        <option value="D-">D-</option>
                        <option value="F">F</option>
                    `;
                        gradeInput.replaceWith(select);
                    } else {
                        const input = document.createElement('input');
                        input.type = 'number';
                        input.className = 'grade-input w-24 p-2 border rounded';
                        input.placeholder = 'Grade';
                        input.min = '2';
                        input.max = '5';
                        input.step = '0.1';
                        gradeInput.replaceWith(input);
                    }
                });
            }

            function addSubject() {
                const container = document.getElementById('subjectsContainer');
                const newRow = document.createElement('div');
                newRow.className = 'subject-row flex md:flex-row flex-col gap-4 bg-gray-50 md:bg-transparent p-4 md:p-0 rounded-lg';

                // Create the HTML for the new row based on current grading system
                newRow.innerHTML = `
        <input type="text" placeholder="Subject Name" class="flex-1 p-2 border rounded">
        ${currentGradingSystem === 'letter' ? `
            <select class="grade-input w-full md:w-24 p-2 border rounded">
                <option value="">Grade</option>
                <option value="A+">A+</option>
                <option value="A">A</option>
                <option value="A-">A-</option>
                <option value="B+">B+</option>
                <option value="B">B</option>
                <option value="B-">B-</option>
                <option value="C+">C+</option>
                <option value="C">C</option>
                <option value="C-">C-</option>
                <option value="D+">D+</option>
                <option value="D">D</option>
                <option value="D-">D-</option>
                <option value="F">F</option>
            </select>
        ` : `
            <input type="number" class="grade-input w-full md:w-24 p-2 border rounded" 
                   placeholder="Grade" min="2" max="5" step="0.1">
        `}
        <input type="number" placeholder="Credits" class="w-full md:w-24 p-2 border rounded" min="0" step="0.5">
        <button onclick="removeSubject(this)" class="p-2 text-red-600 hover:text-red-800 self-end">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
        </button>
    `;

                container.appendChild(newRow);
            }

            function removeSubject(button) {
                const container = document.getElementById('subjectsContainer');
                if (container.children.length > 1) {
                    button.closest('.subject-row').remove();
                }
            }

            function showError(message) {
                const errorSection = document.getElementById('errorSection');
                errorSection.textContent = message;
                errorSection.classList.remove('hidden');
                document.getElementById('resultSection').classList.add('hidden');
            }

            function showResult(gpa) {
                const resultSection = document.getElementById('resultSection');
                const gpaResult = document.getElementById('gpaResult');
                const gpaMessage = document.getElementById('gpaMessage');

                gpaResult.textContent = gpa;

                // Set encouraging message based on GPA
                if (gpa >= 3.5) {
                    gpaMessage.textContent = "Excellent work! Keep up the outstanding performance!";
                } else if (gpa >= 3.0) {
                    gpaMessage.textContent = "Good job! You're performing well above average!";
                } else if (gpa >= 2.5) {
                    gpaMessage.textContent = "You're doing well! Keep pushing yourself to improve!";
                } else {
                    gpaMessage.textContent = "Keep working hard! Every small improvement counts!";
                }

                resultSection.classList.remove('hidden');
                document.getElementById('errorSection').classList.add('hidden');
            }

            // Replace the calculateGPA function with this:

            async function calculateGPA() {
                try {
                    const user = window.auth.currentUser;
                    if (!user) {
                        throw new Error('Please log in to save your GPA');
                    }

                    const subjects = [];
                    let totalPoints = 0;
                    let totalCredits = 0;

                    // Gather subject data
                    document.querySelectorAll('.subject-row').forEach(row => {
                        const subjectName = row.querySelector('input[type="text"]').value;
                        const credits = parseFloat(row.querySelector('input[type="number"]').value);
                        const grade = row.querySelector('.grade-input').value;

                        if (!subjectName || isNaN(credits) || !grade) {
                            throw new Error('Please fill in all fields');
                        }

                        let gradePoints;
                        if (currentGradingSystem === 'letter') {
                            gradePoints = letterToGPA[grade];
                        } else {
                            const numericGrade = parseFloat(grade);
                            if (numericGrade < 2 || numericGrade > 5) {
                                throw new Error('Numeric grades must be between 2.0 and 5.0');
                            }
                            gradePoints = numericToGPA(numericGrade);
                        }

                        subjects.push({
                            subjectName,
                            credits,
                            grade,
                            gradePoints // Store the converted GPA value
                        });
                        totalPoints += gradePoints * credits;
                        totalCredits += credits;
                    });

                    if (totalCredits === 0) {
                        throw new Error('Total credits cannot be zero');
                    }

                    const gpa = totalPoints / totalCredits;
                    const roundedGPA = Math.round(gpa * 100) / 100;

                    // Save to Firebase using a batch
                    const batch = window.db.batch();
                    const userRef = window.db.collection('users').doc(user.uid);
                    const gpaDetailsRef = userRef.collection('gpaDetails').doc('latest');
                    const activityRef = userRef.collection('activity').doc();

                    // Update user document
                    batch.update(userRef, {
                        gpa: roundedGPA,
                        lastGPAUpdate: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // Save GPA details
                    batch.set(gpaDetailsRef, {
                        gpa: roundedGPA,
                        subjects: subjects,
                        gradingSystem: currentGradingSystem,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        totalCredits: totalCredits
                    });

                    // Add activity
                    batch.set(activityRef, {
                        description: `Updated GPA to ${roundedGPA.toFixed(2)} (${currentGradingSystem} scale)`,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // Commit all changes
                    await batch.commit();

                    // Show success message with explanatory text
                    const resultSection = document.getElementById('resultSection');
                    if (resultSection) {
                        const gpaResult = document.getElementById('gpaResult');
                        const gpaMessage = document.getElementById('gpaMessage');

                        if (gpaResult) gpaResult.textContent = roundedGPA.toFixed(2);

                        if (gpaMessage) {
                            let message = '';
                            if (roundedGPA >= 3.5) {
                                message = "Excellent work! Keep up the outstanding performance!";
                            } else if (roundedGPA >= 3.0) {
                                message = "Good job! You're performing well above average!";
                            } else if (roundedGPA >= 2.5) {
                                message = "You're doing well! Keep pushing yourself to improve!";
                            } else {
                                message = "Keep working hard! Every small improvement counts!";
                            }

                            if (currentGradingSystem === 'numeric') {
                                message += " (Converted to 4.0 scale)";
                            }

                            gpaMessage.textContent = message;
                        }

                        resultSection.classList.remove('hidden');
                    }

                    // Hide error section if visible
                    const errorSection = document.getElementById('errorSection');
                    if (errorSection) {
                        errorSection.classList.add('hidden');
                    }

                    // Redirect after short delay
                    setTimeout(() => {
                        window.location.href = '/user';
                    }, 1500);

                } catch (error) {
                    console.error('Error calculating GPA:', error);
                    const errorSection = document.getElementById('errorSection');
                    if (errorSection) {
                        errorSection.textContent = error.message;
                        errorSection.classList.remove('hidden');
                    }
                    const resultSection = document.getElementById('resultSection');
                    if (resultSection) {
                        resultSection.classList.add('hidden');
                    }
                }
            }

            function toggleMobileMenu() {
                const mobileMenu = document.getElementById('mobileMenu');
                const menuIcon = document.getElementById('menuIcon');

                if (mobileMenu.classList.contains('hidden')) {
                    mobileMenu.classList.remove('hidden');
                    menuIcon.setAttribute('d', 'M6 18L18 6M6 6l12 12'); // X icon
                } else {
                    mobileMenu.classList.add('hidden');
                    menuIcon.setAttribute('d', 'M4 6h16M4 12h16M4 18h16'); // Hamburger icon
                }
            }

            // Close mobile menu when window is resized to desktop view
            window.addEventListener('resize', () => {
                if (window.innerWidth >= 768) { // 768px is the md breakpoint in Tailwind
                    const mobileMenu = document.getElementById('mobileMenu');
                    const menuIcon = document.getElementById('menuIcon');
                    mobileMenu.classList.add('hidden');
                    menuIcon.setAttribute('d', 'M4 6h16M4 12h16M4 18h16');
                }
            });

            function updateGradeInputs(type) {
                const rows = document.querySelectorAll('.subject-row');
                rows.forEach(row => {
                    const gradeInput = row.querySelector('.grade-input');

                    if (type === 'letter') {
                        const select = document.createElement('select');
                        select.className = 'grade-input w-full md:w-24 p-2 border rounded';
                        select.innerHTML = `
                <option value="">Grade</option>
                <option value="A+">A+</option>
                <option value="A">A</option>
                <option value="A-">A-</option>
                <option value="B+">B+</option>
                <option value="B">B</option>
                <option value="B-">B-</option>
                <option value="C+">C+</option>
                <option value="C">C</option>
                <option value="C-">C-</option>
                <option value="D+">D+</option>
                <option value="D">D</option>
                <option value="D-">D-</option>
                <option value="F">F</option>
            `;
                        gradeInput.replaceWith(select);
                    } else {
                        const input = document.createElement('input');
                        input.type = 'number';
                        input.className = 'grade-input w-full md:w-24 p-2 border rounded';
                        input.placeholder = 'Grade';
                        input.min = '2';
                        input.max = '5';
                        input.step = '0.1';
                        gradeInput.replaceWith(input);
                    }
                });
            }

            function addSubject() {
                const container = document.getElementById('subjectsContainer');
                const template = document.getElementById('subjectRowTemplate');
                const clone = template.content.cloneNode(true);

                // Update grade input based on current grading system
                const gradeInput = clone.querySelector('.grade-input');
                if (currentGradingSystem === 'numeric') {
                    const numericInput = document.createElement('input');
                    numericInput.type = 'number';
                    numericInput.className = 'grade-input w-full md:w-24 p-2 border rounded';
                    numericInput.placeholder = 'Grade';
                    numericInput.min = '2';
                    numericInput.max = '5';
                    numericInput.step = '0.1';
                    gradeInput.replaceWith(numericInput);
                }

                container.appendChild(clone);
            }

        </script>
    </body>

</html>