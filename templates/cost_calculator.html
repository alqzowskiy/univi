<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>University Cost Calculator - UNIVI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <!-- Add Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>
    {% include 'partials/firebaseconfig.html' %}
    <style>
        .icon-container {
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .cost-card {
            transition: all 0.3s ease;
        }
        
        .cost-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chart-container {
            position: relative;
            margin: auto;
            height: 400px;
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-50">
    {% include 'partials/navigation.html' %}

    <div class="pt-20 pb-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- Header with Icon -->
            <div class="text-center mb-10">
                <div class="inline-block p-4 rounded-full bg-blue-100 mb-4">
                    <i data-feather="calculator" class="w-8 h-8 text-blue-600"></i>
                </div>
                <h1 class="text-4xl font-bold text-gray-900 mb-4">University Cost Calculator</h1>
                <p class="text-xl text-gray-600 max-w-2xl mx-auto">Plan your education budget with our detailed cost estimator</p>
            </div>

            <!-- Calculator Form -->
            <div class="max-w-3xl mx-auto">
                <div class="bg-white rounded-xl shadow-lg p-8 mb-8 transform transition-all hover:scale-[1.01]">
                    <form id="costCalculatorForm" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="relative">
                                <label for="university" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i data-feather="book" class="w-4 h-4 inline mr-2"></i>
                                    University Name
                                </label>
                                <input type="text" id="university" name="university" required
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                            </div>
                            <div class="relative">
                                <label for="country" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i data-feather="globe" class="w-4 h-4 inline mr-2"></i>
                                    Country
                                </label>
                                <input type="text" id="country" name="country" required
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                            </div>
                        </div>
                        <button type="submit"
                                class="w-full bg-blue-600 text-white py-4 px-6 rounded-lg font-medium text-lg hover:bg-blue-700 transition duration-200 shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                            <i data-feather="trending-up" class="w-5 h-5"></i>
                            Calculate Costs
                        </button>
                    </form>
                </div>

                <!-- Results Section -->
                <!-- Results Section -->
<div id="resultsSection" class="hidden space-y-8 animate-fade-in">
    <!-- Cost Overview Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <!-- Monthly Summary -->
        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 shadow-md cost-card relative overflow-hidden">
            <div class="absolute top-0 right-0 w-16 h-16 bg-blue-200 rounded-bl-full opacity-50"></div>
            <div class="flex items-center mb-3">
                <i data-feather="calendar" class="w-5 h-5 text-blue-600 mr-2"></i>
                <h3 class="text-lg font-semibold text-blue-800">Monthly Total</h3>
            </div>
            <p id="monthlyTotal" class="text-3xl font-bold text-blue-600"></p>
            <p class="text-sm text-blue-600 mt-2">Regular expenses</p>
        </div>

        <!-- Yearly Academic -->
        <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-6 shadow-md cost-card relative overflow-hidden">
            <div class="absolute top-0 right-0 w-16 h-16 bg-green-200 rounded-bl-full opacity-50"></div>
            <div class="flex items-center mb-3">
                <i data-feather="book" class="w-5 h-5 text-green-600 mr-2"></i>
                <h3 class="text-lg font-semibold text-green-800">Yearly Academic</h3>
            </div>
            <p id="yearlyAcademic" class="text-3xl font-bold text-green-600"></p>
            <p class="text-sm text-green-600 mt-2">Tuition & fees</p>
        </div>

        <!-- Living Expenses -->
        <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-6 shadow-md cost-card relative overflow-hidden">
            <div class="absolute top-0 right-0 w-16 h-16 bg-purple-200 rounded-bl-full opacity-50"></div>
            <div class="flex items-center mb-3">
                <i data-feather="home" class="w-5 h-5 text-purple-600 mr-2"></i>
                <h3 class="text-lg font-semibold text-purple-800">Living Expenses</h3>
            </div>
            <p id="livingExpenses" class="text-3xl font-bold text-purple-600"></p>
            <p class="text-sm text-purple-600 mt-2">Annual living costs</p>
        </div>

        <!-- Total Investment -->
        <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 rounded-xl p-6 shadow-md cost-card relative overflow-hidden">
            <div class="absolute top-0 right-0 w-16 h-16 bg-indigo-200 rounded-bl-full opacity-50"></div>
            <div class="flex items-center mb-3">
                <i data-feather="dollar-sign" class="w-5 h-5 text-indigo-600 mr-2"></i>
                <h3 class="text-lg font-semibold text-indigo-800">Total Investment</h3>
            </div>
            <p id="totalInvestment" class="text-3xl font-bold text-indigo-600"></p>
            <p class="text-sm text-indigo-600 mt-2">First year total</p>
        </div>
    </div>

    <!-- Detailed Analysis Tabs -->
    <div class="bg-white rounded-xl shadow-lg p-8">
        <div class="flex space-x-4 border-b mb-6">
            <button class="tab-button active px-4 py-2 text-blue-600 border-b-2 border-blue-600" data-tab="monthly">
                <i data-feather="calendar" class="w-4 h-4 inline mr-2"></i>Monthly Breakdown
            </button>
            <button class="tab-button px-4 py-2 text-gray-600 hover:text-blue-600" data-tab="academic">
                <i data-feather="book" class="w-4 h-4 inline mr-2"></i>Academic Costs
            </button>
            <button class="tab-button px-4 py-2 text-gray-600 hover:text-blue-600" data-tab="setup">
                <i data-feather="package" class="w-4 h-4 inline mr-2"></i>Setup & One-time
            </button>
            <button class="tab-button px-4 py-2 text-gray-600 hover:text-blue-600" data-tab="savings">
                <i data-feather="trending-down" class="w-4 h-4 inline mr-2"></i>Savings & Aid
            </button>
        </div>

        <!-- Tab Content -->
        <div id="monthlyTab" class="tab-content active">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Monthly Distribution Chart -->
                <div class="chart-container">
                    <canvas id="monthlyDistributionChart"></canvas>
                </div>
                <!-- Monthly Breakdown List -->
                <div id="monthlyBreakdown" class="space-y-4">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>

        <div id="academicTab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Academic Costs Chart -->
                <div class="chart-container">
                    <canvas id="academicCostsChart"></canvas>
                </div>
                <!-- Program Cost Comparison -->
                <div id="programComparison" class="space-y-4">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>

        <div id="setupTab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Setup Costs Breakdown -->
                <div id="setupCosts" class="space-y-4">
                    <!-- Populated by JavaScript -->
                </div>
                <!-- Timeline View -->
                <div id="setupTimeline" class="space-y-4">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>

        <div id="savingsTab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Savings Opportunities -->
                <div id="savingsOpportunities" class="space-y-4">
                    <!-- Populated by JavaScript -->
                </div>
                <!-- Financial Aid Options -->
                <div id="financialAid" class="space-y-4">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Local Context Section -->
    <div class="bg-white rounded-xl shadow-lg p-8">
        <h2 class="text-2xl font-bold mb-6 flex items-center">
            <i data-feather="map-pin" class="w-6 h-6 mr-2 text-blue-600"></i>
            Local Cost Context
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="localContext">
            <!-- Populated by JavaScript -->
        </div>
    </div>
</div>
</div>
            </div>
        </div>
    </div>

    <script>
      // Initialize variables and setup
let charts = {
    monthlyDistribution: null,
    academicCosts: null,
    savingsBreakdown: null
};

// Initialize Feather Icons
feather.replace();

// Tab switching functionality
document.querySelectorAll('.tab-button').forEach(button => {
    button.addEventListener('click', () => {
        // Remove active class from all buttons and contents
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active', 'text-blue-600', 'border-b-2', 'border-blue-600'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        
        // Add active class to clicked button
        button.classList.add('active', 'text-blue-600', 'border-b-2', 'border-blue-600');
        
        // Show corresponding content
        const tabId = button.dataset.tab + 'Tab';
        document.getElementById(tabId).classList.remove('hidden');
        
        // Refresh charts if necessary
        if (charts[button.dataset.tab]) {
            charts[button.dataset.tab].update();
        }
    });
});

// Enhanced form submission handler
document.getElementById('costCalculatorForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const submitButton = e.target.querySelector('button[type="submit"]');
    
    // Show loading state
    submitButton.disabled = true;
    submitButton.innerHTML = `
        <svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
        </svg>
        Calculating...
    `;
    
    try {
        const response = await fetch('/calculate-costs', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }

        // Show results section with animation
        const resultsSection = document.getElementById('resultsSection');
        resultsSection.classList.remove('hidden');
        resultsSection.scrollIntoView({ behavior: 'smooth' });

        // Update all sections
        updateSummaryCards(data);
        updateMonthlyBreakdown(data.monthly_costs);
        updateAcademicCosts(data.yearly_costs);
        updateSetupCosts(data.one_time_costs);
        updateSavingsInfo(data.savings_opportunities, data.financial_aid);
        updateLocalContext(data.local_cost_context);

    } catch (error) {
        showError(error.message || 'Error calculating costs');
    } finally {
        // Reset button
        submitButton.disabled = false;
        submitButton.innerHTML = `
            <i data-feather="trending-up" class="w-5 h-5 mr-2"></i>
            Calculate Costs
        `;
        feather.replace();
    }
});

// Update summary cards with animations
function updateSummaryCards(data) {
    animateValue('monthlyTotal', data.totals.monthly.amount, {
        prefix: '$',
        duration: 1000,
        useGrouping: true
    });

    animateValue('yearlyAcademic', data.totals.yearly.amount, {
        prefix: '$',
        duration: 1000,
        useGrouping: true
    });

    animateValue('livingExpenses', data.totals.monthly.amount * 12, {
        prefix: '$',
        duration: 1000,
        useGrouping: true
    });

    animateValue('totalInvestment', data.totals.first_year.amount, {
        prefix: '$',
        duration: 1000,
        useGrouping: true
    });
}

// Enhanced monthly breakdown with detailed information
function updateMonthlyBreakdown(monthlyData) {
    const container = document.getElementById('monthlyBreakdown');
    container.innerHTML = '';

    Object.entries(monthlyData).forEach(([category, data]) => {
        const card = document.createElement('div');
        card.className = 'bg-gray-50 rounded-lg p-4 transform transition-all hover:scale-[1.02] space-y-3';
        
        // Main cost info
        const mainInfo = `
            <div class="flex items-center justify-between mb-2">
                <h4 class="font-medium text-gray-900 capitalize flex items-center">
                    <i data-feather="${getCategoryIcon(category)}" class="w-4 h-4 mr-2"></i>
                    ${formatCategoryName(category)}
                </h4>
                <span class="text-lg font-bold text-blue-600">${formatCurrency(data.amount)}</span>
            </div>
            <p class="text-sm text-gray-600">${data.details}</p>
        `;
        
        // Breakdown if available
        let breakdownHtml = '';
        if (data.breakdown) {
            breakdownHtml = `
                <div class="mt-2 pt-2 border-t border-gray-200">
                    <p class="text-xs font-medium text-gray-500 mb-1">Breakdown:</p>
                    <div class="grid grid-cols-2 gap-2">
                        ${Object.entries(data.breakdown)
                            .map(([item, cost]) => `
                                <div class="flex justify-between">
                                    <span class="text-xs text-gray-600">${formatCategoryName(item)}</span>
                                    <span class="text-xs font-medium">${formatCurrency(cost)}</span>
                                </div>
                            `).join('')}
                    </div>
                </div>
            `;
        }

        // Options if available
        let optionsHtml = '';
        if (data.options) {
            optionsHtml = `
                <div class="mt-2 pt-2 border-t border-gray-200">
                    <p class="text-xs font-medium text-gray-500 mb-1">Available Options:</p>
                    <div class="space-y-1">
                        ${data.options
                            .map(option => `
                                <div class="flex justify-between">
                                    <span class="text-xs text-gray-600">${option.type}</span>
                                    <span class="text-xs font-medium">${formatCurrency(option.cost)}</span>
                                </div>
                            `).join('')}
                    </div>
                </div>
            `;
        }

        card.innerHTML = mainInfo + breakdownHtml + optionsHtml;
        container.appendChild(card);
    });
    
    feather.replace();
    updateMonthlyChart(monthlyData);
}

// Update the monthly distribution chart
function updateMonthlyChart(monthlyData) {
    const ctx = document.getElementById('monthlyDistributionChart').getContext('2d');
    
    if (charts.monthlyDistribution) {
        charts.monthlyDistribution.destroy();
    }

    const labels = Object.keys(monthlyData).map(key => formatCategoryName(key));
    const amounts = Object.values(monthlyData).map(item => item.amount);
    const total = amounts.reduce((a, b) => a + b, 0);

    charts.monthlyDistribution = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: amounts,
                backgroundColor: [
                    'rgba(59, 130, 246, 0.7)',   // Blue
                    'rgba(16, 185, 129, 0.7)',   // Green
                    'rgba(249, 115, 22, 0.7)',   // Orange
                    'rgba(139, 92, 246, 0.7)',   // Purple
                    'rgba(236, 72, 153, 0.7)',   // Pink
                    'rgba(245, 158, 11, 0.7)'    // Yellow
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        font: {
                            size: 12
                        },
                        generateLabels: (chart) => {
                            const data = chart.data;
                            return data.labels.map((label, i) => ({
                                text: `${label} (${((data.datasets[0].data[i] / total) * 100).toFixed(1)}%)`,
                                fillStyle: data.datasets[0].backgroundColor[i],
                                hidden: false,
                                index: i
                            }));
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: (context) => {
                            const value = context.raw;
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${formatCurrency(value)} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

// Helper functions
function formatCategoryName(category) {
    return category
        .split('_')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(amount);
}

function getCategoryIcon(category) {
    const icons = {
        accommodation: 'home',
        food: 'coffee',
        transport: 'map',
        utilities: 'zap',
        personal: 'user',
        study: 'book',
        entertainment: 'music',
        health: 'heart',
        default: 'circle'
    };
    return icons[category] || icons.default;
}

function animateValue(elementId, endValue, options = {}) {
    const element = document.getElementById(elementId);
    const startValue = 0;
    const duration = options.duration || 1000;
    const startTime = performance.now();
    
    function updateValue(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        const value = Math.floor(startValue + (endValue - startValue) * progress);
        element.textContent = formatCurrency(value);
        
        if (progress < 1) {
            requestAnimationFrame(updateValue);
        }
    }
    
    requestAnimationFrame(updateValue);
}

function showError(message) {
    const alert = document.createElement('div');
    alert.className = 'fixed top-4 right-4 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded shadow-lg';
    alert.innerHTML = `
        <div class="flex items-center">
            <i data-feather="alert-circle" class="w-5 h-5 mr-2"></i>
            <p>${message}</p>
        </div>
    `;
    document.body.appendChild(alert);
    feather.replace();
    
    setTimeout(() => {
        alert.remove();
    }, 5000);
}
    </script>
</body>
</html>